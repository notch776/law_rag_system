<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客服工作台</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-indigo-600 text-white p-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">客服工作台</h1>
                <p class="text-sm opacity-80" v-if="!isConnected">连接中...</p>
                <p class="text-sm opacity-80" v-else>已连接</p>
            </div>

            <div class="d-flex h-[700px]">
                <!-- left: conversations list -->
                <div class="w-1/4 border-r overflow-y-auto">
                    <div class="p-2 bg-gray-50 border-b">
                        <h2 class="font-semibold text-gray-700">等待处理 ({{ waitingConversations.length }})</h2>
                    </div>

                    <div class="divide-y">
                        <div
                            v-for="conv in waitingConversations"
                            :key="conv.conversation_id"
                            class="p-3 hover:bg-blue-50 cursor-pointer d-flex justify-content-between align-items-center"
                            @click="acceptConversation(conv.conversation_id)"
                        >
                            <div v-for="conv in waitingConversations" :key="conv.conversation_id">
                                <p class="font-medium">对话 {{ conv.source_conversation_id }}</p>
                                <p class="text-sm text-gray-500">{{ conv.message_count }} 条消息</p>
                                <!-- need human -->
                                <p v-if="conv.is_human_request" class="text-xs text-red-500">转人工请求</p>
                            </div>
                            <button class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">
                                接受
                            </button>
                        </div>
                    </div>

                    <div class="p-2 bg-gray-50 border-b mt-4">
                        <h2 class="font-semibold text-gray-700">正在处理</h2>
                    </div>

                    <div class="divide-y">
                        <div
                            v-for="conv in activeConversations"
                            :key="conv.conversation_id"
                            class="p-3 hover:bg-blue-50 cursor-pointer"
                            @click="selectConversation(conv.conversation_id)"
                            :class="selectedConversationId === conv.conversation_id ? 'bg-blue-100' : ''"
                        >
                            <p class="font-medium">对话 {{ conv.source_conversation_id }}</p>
                            <p class="text-sm text-gray-500">{{ conv.messages.length }} 条消息</p>
                        </div>
                    </div>
                </div>

                <!-- right: chat window -->
                <div class="w-3/4 d-flex flex-column">
                    <div v-if="!selectedConversation" class="flex-1 d-flex align-items-center justify-content-center text-gray-500">
                        请选择一个对话
                    </div>

                    <div v-else class="d-flex flex-column h-100">
                        <div class="p-3 border-b bg-gray-50">
                            <h2 class="font-semibold">与 用户 {{ selectedConversation.user_id }} 的对话</h2>
                        </div>

                        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messages">
                            <div v-for="(msg, index) in selectedConversation.messages" :key="index" class="d-flex" :class="msg.sender === 'support' ? 'justify-content-end' : 'justify-content-start'">
                                <div :class="msg.sender === 'support' ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'" class="px-4 py-2 rounded-lg max-w-[80%]">
                                    {{ msg.content }}
                                    <!-- time -->
                                    <div class="text-xs mt-1 opacity-75">{{ formatTime(msg.timestamp) }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- input area -->
                        <div class="p-4 border-top mt-auto">
                            <div class="d-flex">
                                <input
                                    v-model="newMessage"
                                    @keyup.enter="sendMessage"
                                    type="text"
                                    placeholder="输入回复..."
                                    class="flex-1 px-4 py-2 border rounded-start-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                <button
                                    @click="sendMessage"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-end-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                                    :disabled="!newMessage.trim()"
                                >
                                    <i class="fa fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        const supportId = "{{SUPPORT_ID}}";

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    supportId: supportId,
                    newMessage: '',
                    socket: null,
                    isConnected: false,
                    waitingConversations: [],
                    activeConversations: [],
                    selectedConversationId: null
                }
            },
            computed: {
                selectedConversation() {
                    return this.activeConversations.find(conv => conv.conversation_id === this.selectedConversationId) || null;
                }
            },
            mounted() {
                this.connectWebSocket();

                console.log('客服工作台初始化，等待处理的对话数:', this.waitingConversations.length);
            },
            methods: {
                formatTime(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString();
                },
                connectWebSocket() {

                    const wsUrl = `ws://${window.location.host}/ws/support/${this.supportId}`;
                    console.log('尝试连接WebSocket:', wsUrl);
                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        console.log('WebSocket连接已打开');
                        this.isConnected = true;
                    };

                    this.socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('收到消息:', data);

                            switch (data.type) {
                                case 'waiting_conversations':
                                    this.waitingConversations = data.conversations;
                                    break;

                                case 'new_waiting_conversation':

                                    const newConversation = {
                                        conversation_id: data.conversation_id,
                                        source_conversation_id: data.source_conversation_id,
                                        message_count: 1,
                                        is_human_request: data.is_human_request || false
                                    };
                                    this.waitingConversations.push(newConversation);
                                    console.log('新的等待对话，总数:', this.waitingConversations.length);
                                    break;

                                case 'conversation_accepted':

                                    this.waitingConversations = this.waitingConversations.filter(
                                        conv => conv.conversation_id !== data.conversation_id
                                    );
                                    break;

                                case 'conversation_history':

                                    this.activeConversations.push({
                                        conversation_id: data.conversation_id,
                                        source_conversation_id: this.waitingConversations.find(
                                            conv => conv.conversation_id === data.conversation_id
                                        )?.source_conversation_id || '未知用户',
                                        messages: data.messages
                                    });


                                    this.waitingConversations = this.waitingConversations.filter(
                                        conv => conv.conversation_id !== data.conversation_id
                                    );


                                    this.selectConversation(data.conversation_id);
                                    break;

                                case 'new_message':

                                    const convIndex = this.activeConversations.findIndex(
                                        conv => conv.conversation_id === data.conversation_id
                                    );

                                    if (convIndex !== -1) {
                                        this.activeConversations[convIndex].messages.push(data.message);
                                        this.scrollToBottom();
                                    }
                                    break;

                                case 'conversation_closed':

                                    this.activeConversations = this.activeConversations.filter(
                                        conv => conv.conversation_id !== data.conversation_id
                                    );

                                    if (this.selectedConversationId === data.conversation_id) {
                                        this.selectedConversationId = null;
                                    }
                                    break;
                            }
                        } catch (error) {
                            console.error('处理消息时出错:', error, '消息内容:', event.data);
                        }
                    };

                    this.socket.onclose = () => {
                        console.log('WebSocket连接已关闭');
                        this.isConnected = false;

                        setTimeout(() => this.connectWebSocket(), 3000);
                    };

                    this.socket.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                    };
                },

                acceptConversation(conversationId) {
                    if (!this.isConnected) return;

                    this.socket.send(JSON.stringify({
                        type: "accept_conversation",
                        conversation_id: conversationId
                    }));
                },

                selectConversation(conversationId) {
                    this.selectedConversationId = conversationId;
                    this.newMessage = '';
                    setTimeout(() => this.scrollToBottom(), 0);
                },

                sendMessage() {
                    if (!this.newMessage.trim() || !this.selectedConversationId || !this.isConnected) return;


                    this.socket.send(JSON.stringify({
                        type: "send_message",
                        conversation_id: this.selectedConversationId,
                        content: this.newMessage
                    }));


                    const convIndex = this.activeConversations.findIndex(
                        conv => conv.conversation_id === this.selectedConversationId
                    );

                    if (convIndex !== -1) {
                        this.activeConversations[convIndex].messages.push({
                            content: this.newMessage,
                            sender: 'support',
                            timestamp: new Date().toISOString()
                        });
                    }

                    this.newMessage = '';
                    this.scrollToBottom();
                },

                scrollToBottom() {
                    const messagesContainer = document.getElementById('messages');
                    if (messagesContainer) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>